{{ template "header" . }}
<script src="/assets/script.js"></script>

<form method="POST" action="/{{ .action }}" class="form" id="editor">
  {{ .csrf }}
	<div class="field">
		<textarea id="content" name="content">{{ .content }}</textarea>
	</div>
  <button type="submit" class="button is-link"
          style="position: fixed; right:1em; bottom:1em;z-index: 10;">
    <span class="icon"><i class="fa-solid fa-floppy-disk"></i></span>
    <span>Save</span>
  </button>
</form>

<script type="application/javascript">
 CodeMirror.defineOption('autoSuggest', [], function (cm, value, old) {
     cm.on('inputRead', function (cm, change) {
         var mode = cm.getModeAt(cm.getCursor());

         for (var i = 0, len = value.length; i < len; i++) {
             if (mode.name === value[i].mode && change.text[0] === value[i].startChar) {
                 cm.showHint({
                     completeSingle: false,
                     hint: (function(iterator){
                         return function (cm, options) {
                             var cur = cm.getCursor(),
                                 token = cm.getTokenAt(cur);
                             var start = token.start,
                                 end = token.end;
                             for(
                                 start = token.end;
                                 start>0 && cm.getTokenAt({line: cur.line, ch: start}).string != value[iterator].startChar;
                                 start--
                             ){}

                             var filter = editor
                                 .getDoc()
                                 .getRange({line: cur.line, ch: start}, {line: cur.line, ch: end})
                                 .toLowerCase();
                             var allList = value[iterator].listCallback();
                             var filtered = allList.filter(e => e.text.toLowerCase().includes(filter));

                             return {
                                 list: filtered,
                                 from: CodeMirror.Pos(cur.line, start-1),
                                 to: CodeMirror.Pos(cur.line, end)
                             };
                         }
                     })(i)
                 });
             }
         }
     });
 });
</script>

<script type="application/javascript">
 var form = document.getElementById("editor");
 var content = document.getElementById("content");
 var editor = CodeMirror.fromTextArea(content, {
     mode: "gfm",
     autofocus: true,
     spellcheck: true,
     lineWrapping: true,
     viewportMargin: Infinity,
     direction: {{ if .rtl }} "rtl" {{ else }} "ltr" {{ end }},
     autoSuggest: [

        {{ range .autocomplete }}
         {
             mode: 'markdown',
             startChar: '{{.StartChar}}',
             listCallback: function() {
                 return [
                    {{range .Suggestions }}
                     {
                         text: '{{.Text}} ',
                         displayText: '{{.DisplayText}}'
                     },
                    {{end}}
                 ]
             }
         },
        {{ end }}

     ]
 });

 document.addEventListener('keydown', function(event) {
     const e = event || window.event;
     if ( e.key === 's' && (e.ctrlKey || e.metaKey ) ) {
         e.preventDefault();
        document.getElementById("editor").submit();
     }
 });
</script>
{{ template "footer" . }}
